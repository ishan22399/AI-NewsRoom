{% extends "base.html" %}

{% block title %}{{ article.title }} - AI Newsroom{% endblock %}

{% block extra_css %}
<style>
    /* Reading progress bar */
    .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 4px;
        background: linear-gradient(to right, #4f46e5, #a78bfa);
        z-index: 50;
        transition: width 0.1s ease;
    }
    
    /* Article content styling */
    .article-content {
        font-size: 1.125rem;
        line-height: 1.8;
        color: #374151;
    }
    
    .article-content p {
        margin-bottom: 1.5rem;
    }
    
    .article-content h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-top: 2rem;
        margin-bottom: 1rem;
        color: #1f2937;
    }
    
    .article-content a {
        color: #4f46e5;
        text-decoration: underline;
        text-decoration-thickness: 1px;
        text-underline-offset: 2px;
    }
    
    .article-content blockquote {
        border-left: 4px solid #4f46e5;
        padding-left: 1rem;
        margin-left: 0;
        margin-right: 0;
        font-style: italic;
        color: #4b5563;
        margin-bottom: 1.5rem;
    }
    
    .article-content ul, .article-content ol {
        margin-bottom: 1.5rem;
        margin-left: 1.5rem;
    }
    
    .article-content li {
        margin-bottom: 0.5rem;
    }
    
    .article-content pre {
        background-color: #f3f4f6;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-bottom: 1.5rem;
    }
    
    .article-content img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin: 1.5rem 0;
        cursor: pointer;
    }
    
    /* Table of contents */
    .toc {
        position: sticky;
        top: 5rem;
        max-height: calc(100vh - 8rem);
        overflow-y: auto;
        scrollbar-width: thin;
    }
    
    .toc::-webkit-scrollbar {
        width: 4px;
    }
    
    .toc::-webkit-scrollbar-track {
        background: #f3f4f6;
    }
    
    .toc::-webkit-scrollbar-thumb {
        background-color: #d1d5db;
        border-radius: 4px;
    }
    
    .toc-link {
        position: relative;
        display: block;
        padding: 0.5rem 0;
        padding-left: 1rem;
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
        color: #4b5563;
        border-left: 2px solid #e5e7eb;
        transition: all 0.2s;
    }
    
    .toc-link:hover {
        color: #1f2937;
        border-left-color: #9ca3af;
    }
    
    .toc-link.active {
        color: #4f46e5;
        border-left-color: #4f46e5;
        font-weight: 500;
    }
    
    /* Lightbox */
    .lightbox {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    
    .lightbox.active {
        opacity: 1;
        pointer-events: auto;
    }
    
    .lightbox-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
    }
    
    .lightbox-img {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
    }
    
    .lightbox-close {
        position: absolute;
        top: -2rem;
        right: 0;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
    }
    
    /* Highlight text animation */
    .highlight {
        position: relative;
        display: inline;
        color: #4f46e5;
        font-weight: 500;
    }
    
    .highlight::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0.3em;
        background-color: rgba(79, 70, 229, 0.2);
        z-index: -1;
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
    }
    
    .highlight.animate::after {
        transform: scaleX(1);
    }
    
    /* Print mode */
    @media print {
        .no-print {
            display: none !important;
        }
        
        .article-content {
            font-size: 12pt;
            line-height: 1.6;
        }
        
        .article-content img {
            max-width: 500px;
            margin: 1rem auto;
        }
        
        body {
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .container {
            max-width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
        }
    }
    
    /* Category badges */
    .category-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
        color: white;
        border-radius: 9999px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .category-tech {
        background-color: #4f46e5;
    }
    
    .category-business {
        background-color: #0891b2;
    }
    
    .category-politics {
        background-color: #b91c1c;
    }
    
    .category-science {
        background-color: #15803d;
    }
    
    .category-health {
        background-color: #ea580c;
    }
    
    .category-default {
        background-color: #6b7280;
    }
    
    /* Read time tooltip */
    .read-time-tooltip {
        position: relative;
    }
    
    .read-time-tooltip .tooltip-text {
        visibility: hidden;
        width: 150px;
        background-color: #1f2937;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.75rem;
    }
    
    .read-time-tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
    
    /* Toast notification */
    .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background-color: #1f2937;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 50;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
    }
    
    .toast.show {
        transform: translateY(0);
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<!-- Reading progress bar -->
<div class="reading-progress" id="readingProgress"></div>

<!-- Article container -->
<div class="max-w-5xl mx-auto px-4 py-6 md:py-12">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Main article content -->
        <div class="lg:col-span-8">
            <!-- Article header -->
            <header class="mb-8">
                <!-- Breadcrumbs -->
                <nav class="mb-4 text-sm text-gray-500">
                    <ol class="flex items-center space-x-2">
                        <li><a href="{{ url_for('dashboard') }}" class="hover:text-indigo-600">Home</a></li>
                        <li class="flex items-center space-x-2">
                            <span>/</span>
                            <a href="#" class="hover:text-indigo-600">{{ article.category|default('News') }}</a>
                        </li>
                        <li class="flex items-center space-x-2">
                            <span>/</span>
                            <span class="text-gray-700">Article</span>
                        </li>
                    </ol>
                </nav>
                
                <!-- Title & Metadata -->
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">{{ article.title }}</h1>
                
                <div class="flex flex-wrap items-center text-sm text-gray-500 mb-6 gap-4">
                    <div class="flex items-center">
                        <span class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-2">
                            <i class="fas fa-user text-indigo-600"></i>
                        </span>
                        <span>{{ article.author|default('Unknown Author') }}</span>
                    </div>
                    
                    <div class="flex items-center">
                        <i class="far fa-calendar-alt mr-2 text-gray-400"></i>
                        <span>{{ article.published_at }}</span>
                    </div>
                    
                    <div class="flex items-center read-time-tooltip">
                        <i class="far fa-clock mr-2 text-gray-400"></i>
                        <span data-reading-time>{{ article.read_time }} min read</span>
                        <span class="tooltip-text">Estimated reading time</span>
                    </div>
                    
                    <div class="flex items-center">
                        <i class="far fa-newspaper mr-2 text-gray-400"></i>
                        <span>{{ article.source.name|default('Unknown Source') }}</span>
                    </div>
                </div>
                
                <!-- Tags -->
                <div class="flex flex-wrap gap-2 mb-6">
                    {% for tag in article.tags %}
                    <a href="#" class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-sm hover:bg-indigo-100 transition-colors">
                        {{ tag }}
                    </a>
                    {% endfor %}
                </div>
            </header>
            
            <!-- Featured image -->
            <div class="article-hero-image mb-8 rounded-xl overflow-hidden relative">
                <img src="{{ article.image_url }}" 
                     alt="{{ article.title }}" 
                     class="w-full h-auto object-cover"
                     onerror="this.src='https://via.placeholder.com/1200x630/4f46e5/ffffff?text=Article+Image'">
                <div class="absolute bottom-4 right-4">
                    <button class="bg-white bg-opacity-80 hover:bg-opacity-100 rounded-full p-2 text-gray-700 hover:text-indigo-600 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" onclick="window.open('{{ article.image_url }}', '_blank')">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- Article content -->
            <article class="article-content mb-12" data-article-id="{{ article.id }}">
                {% if article.content|length > 100 %}
                    {{ article.content|safe }}
                {% else %}
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
                    <p class="text-gray-700 mb-4">The full article content could not be loaded. This may be due to the source website's restrictions or the content format.</p>
                    
                    {% if article.description %}
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2">Article Summary</h3>
                        <p>{{ article.description }}</p>
                    </div>
                    {% endif %}
                    
                    <a href="{{ article.url }}" target="_blank" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-external-link-alt mr-2"></i> Read full article at original source
                    </a>
                </div>
                {% endif %}
                
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <p class="text-sm text-gray-500">
                        Source: <a href="{{ article.url|default('#') }}" target="_blank" class="text-indigo-600 hover:text-indigo-800">{{ article.source.name|default('Unknown Source') }}</a>
                    </p>
                </div>
            </article>
            
            <!-- Article actions -->
            <div class="flex flex-wrap items-center justify-between py-6 border-t border-b border-gray-200 mb-12">
                <!-- Left side: Share -->
                <div class="flex space-x-2 mb-4 sm:mb-0">
                    <button class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors flex items-center">
                        <i class="fas fa-bookmark mr-2"></i> Save
                    </button>
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center" id="shareButton">
                        <i class="fas fa-share-alt mr-2"></i> Share
                    </button>
                    <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center" onclick="window.print()">
                        <i class="fas fa-print mr-2"></i> Print
                    </button>
                </div>
                
                <!-- Right side: Reactions -->
                <div class="flex space-x-3">
                    <button class="flex items-center text-gray-500 hover:text-indigo-600 transition-colors">
                        <i class="far fa-thumbs-up mr-1"></i>
                        <span>Like</span>
                    </button>
                    <button class="flex items-center text-gray-500 hover:text-indigo-600 transition-colors">
                        <i class="far fa-comment mr-1"></i>
                        <span>Comment</span>
                    </button>
                </div>
            </div>
            
            <!-- Related articles -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Related Articles</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% for related in related_articles|default([]) %}
                    <a href="{{ related.url|default('#') }}" class="flex flex-col h-full group">
                        <div class="relative overflow-hidden rounded-lg mb-3">
                            <img src="{{ related.image_url|default('https://via.placeholder.com/400x300/4f46e5/ffffff?text=Related') }}" 
                                 alt="{{ related.title }}" 
                                 class="w-full aspect-video object-cover group-hover:scale-105 transition-transform duration-300">
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 group-hover:text-indigo-600 transition-colors line-clamp-2">{{ related.title }}</h3>
                        <p class="text-sm text-gray-500 mt-1 line-clamp-2">{{ related.summary }}</p>
                        <div class="mt-auto pt-2 text-xs text-gray-500">
                            <span>{{ related.source }} Â· {{ related.published_at }}</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <aside class="lg:col-span-4 order-first lg:order-last">
            <!-- Table of contents -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6 sticky top-24">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Table of Contents</h3>
                <div class="toc" id="tableOfContents">
                    <!-- Dynamically generated -->
                    <div class="text-sm text-gray-500">
                        Content sections will appear here as you scroll.
                    </div>
                </div>
            </div>
            
            <!-- AI Summary -->
            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-5 mb-6 border border-indigo-100">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                        <i class="fas fa-robot text-indigo-600"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">AI Summary</h3>
                </div>
                <p class="text-gray-700 mb-4">
                    {{ article.description|default('No summary available for this article.') }}
                </p>
                <button class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
                    <i class="fas fa-magic mr-1"></i> Generate deeper analysis
                </button>
            </div>
            
            <!-- Ask AI about this article -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Ask AI about this article</h3>
                <div class="mb-4">
                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ask a question about this article...">
                </div>
                <div class="flex space-x-2">
                    <button class="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">What are the key points?</button>
                    <button class="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">Explain further</button>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="imageLightbox">
    <div class="lightbox-content">
        <span class="lightbox-close" onclick="window.closeLightbox()">&times;</span>
        <img class="lightbox-img" id="lightboxImage" src="" alt="Enlarged Image">
    </div>
</div>

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<!-- JavaScript -->
<script>
// Update reading progress bar
function updateReadingProgress() {
    const article = document.querySelector('.article-content');
    if (!article) return;
    
    const scrollTop = window.scrollY;
    const scrollHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const progressBar = document.getElementById('readingProgress');
    
    if (scrollTop === 0) {
        progressBar.style.width = '0%';
        return;
    }
    
    const scrolled = (scrollTop / (scrollHeight - windowHeight)) * 100;
    progressBar.style.width = Math.min(scrolled, 100) + '%';
    
    // Only track complete reads if we're near the end
    if (scrolled > 85 && !window.readingCompleted) {
        window.readingCompleted = true;
        
        // Record complete read event
        fetch('/api/articles/read-complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                article_id: '{{ article.id }}',
                read_time: Math.round((new Date() - window.startTime) / 1000 / 60) // time in minutes
            })
        }).catch(err => console.log('Error tracking reading completion'));
    }
}

// Set up image lightbox
window.openLightbox = function(imgSrc) {
    document.getElementById('lightboxImage').src = imgSrc;
    document.getElementById('imageLightbox').classList.add('active');
    document.body.style.overflow = 'hidden';
    document.addEventListener('keydown', handleLightboxKeyDown);
};

window.closeLightbox = function() {
    document.getElementById('imageLightbox').classList.remove('active');
    document.body.style.overflow = '';
    document.removeEventListener('keydown', handleLightboxKeyDown);
};

function handleLightboxKeyDown(e) {
    if (e.key === 'Escape') {
        window.closeLightbox();
    }
}

// ===== Implement Table of Contents highlighting =====
function updateTOC() {
    // Dynamically build ToC based on headings
    const article = document.querySelector('.article-content');
    const toc = document.getElementById('tableOfContents');
    const headings = article.querySelectorAll('h2, h3');
    
    if (headings.length === 0) {
        toc.innerHTML = '<p class="text-sm text-gray-500">No sections available for this article.</p>';
        return;
    }
    
    // Build ToC if not already built
    if (toc.children.length <= 1) {
        let tocHTML = '';
        
        headings.forEach((heading, index) => {
            const id = `section-${index}`;
            heading.id = id;
            
            const indent = heading.tagName === 'H3' ? 'ml-4' : '';
            tocHTML += `<a href="#${id}" class="toc-link ${indent}" data-section="${id}">${heading.textContent}</a>`;
        });
        
        toc.innerHTML = tocHTML || '<p class="text-sm text-gray-500">No sections available for this article.</p>';
    }
    
    // Update active section
    const tocLinks = document.querySelectorAll('.toc-link');
    if (tocLinks.length === 0) return;
    
    let activeSection = null;
    
    headings.forEach((heading) => {
        const rect = heading.getBoundingClientRect();
        if (rect.top <= 150) { // Adjust based on your layout
            activeSection = heading.id;
        }
    });
    
    tocLinks.forEach(link => {
        link.classList.remove('active');
        if (link.dataset.section === activeSection) {
            link.classList.add('active');
        }
    });
}

// ===== Toast notification function =====
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Initialize everything when DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize reading progress
    updateReadingProgress();
    window.addEventListener('scroll', updateReadingProgress);
    window.startTime = new Date();
    
    // Pre-load images to avoid flicker during lightbox
    const articleImages = document.querySelectorAll('.article-content img, .article-hero-image img');
    articleImages.forEach(img => {
        const tempImage = new Image();
        tempImage.src = img.src;
        img.addEventListener('click', function() {
            window.openLightbox(img.src);
        });
    });
    
    // Add smooth scrolling for TOC links
    document.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            
            if (targetElement) {
                window.scrollTo({
                    top: targetElement.offsetTop - 100,
                    behavior: 'smooth'
                });
                
                // Update URL without page reload
                history.pushState(null, null, targetId);
            }
        });
    });
    
    // Check for URL hash on page load and scroll to that section
    if (window.location.hash) {
        const targetElement = document.querySelector(window.location.hash);
        if (targetElement) {
            setTimeout(() => {
                window.scrollTo({
                    top: targetElement.offsetTop - 100,
                    behavior: 'smooth'
                });
            }, 300);
        }
    }
    
    // Enable image zoom effect for all article images
    const contentImages = document.querySelectorAll('.article-content img');
    contentImages.forEach(img => {
        img.style.cursor = 'pointer';
    });
    
    // Highlight text animation on scroll
    const highlights = document.querySelectorAll('.highlight');
    const animateHighlights = function() {
        highlights.forEach(highlight => {
            const rect = highlight.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            
            if (rect.top < viewportHeight * 0.85 && rect.bottom > 0) {
                highlight.classList.add('animate');
            } else {
                highlight.classList.remove('animate');
            }
        });
    };
    
    // Run highlight animation on scroll
    window.addEventListener('scroll', animateHighlights);
    // Run once on load
    animateHighlights();
    
    // Track reading time
    let startTime = new Date();
    let readingTimeLogged = false;
    
    window.addEventListener('scroll', function() {
        updateTOC();
    });
    
    // Store article view in reading history
    const storeArticleView = function() {
        // In a real app, we would call an API endpoint to store the view
        console.log('Article view recorded');
    };
    
    // Store this article view
    storeArticleView();
    
    // Setup estimated reading time
    const setupReadingTime = function() {
        const article = document.querySelector('.article-content');
        if (!article) return;
        
        const text = article.textContent || '';
        const wordCount = text.split(/\s+/).length;
        // Average reading speed: 200-250 words per minute
        const readingTime = Math.ceil(wordCount / 225);
        
        // Update reading time display if element exists
        const readingTimeElement = document.querySelector('[data-reading-time]');
        if (readingTimeElement) {
            readingTimeElement.textContent = `${readingTime} min read`;
        }
    };
    
    setupReadingTime();
    
    // Enable responsive tables
    const tables = document.querySelectorAll('.article-content table');
    tables.forEach(table => {
        // Wrap table in a responsive container if not already
        if (!table.parentNode.classList.contains('table-responsive')) {
            const wrapper = document.createElement('div');
            wrapper.className = 'table-responsive overflow-x-auto mb-6';
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
        }
    });
    
    // Image error handling
    document.querySelectorAll('img').forEach(img => {
        img.addEventListener('error', function() {
            this.src = 'https://via.placeholder.com/800x450/4f46e5/ffffff?text=Image+Not+Available';
        });
    });
    
    // Track scroll position to detect when user reaches end of article
    let articleRead = false;
    const article = document.querySelector('.article-content');
    
    window.addEventListener('scroll', function() {
        if (articleRead) return;
        
        const scrollPosition = window.scrollY + window.innerHeight;
        const articleBottom = article.offsetTop + article.offsetHeight;
        
        // If user has scrolled to bottom of article
        if (scrollPosition >= articleBottom - 200) { // 200px threshold
            articleRead = true;
            
            // Get article ID from the page
            const articleId = document.querySelector('[data-article-id]').dataset.articleId;
            
            // Send completion notification
            fetch('/api/articles/read-complete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    article_id: articleId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.points_awarded > 0) {
                    // Show a small notification about points
                    const notification = document.createElement('div');
                    notification.className = 'points-notification';
                    notification.innerHTML = `<span>+${data.points_awarded} points!</span>`;
                    document.body.appendChild(notification);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });
});


// Progressive enhancement for browsers with Intersection Observer support
if ('IntersectionObserver' in window) {
    // Lazy load images that are not immediately visible
    const lazyImageObserver = new IntersectionObserver(function(entries, observer) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                observer.unobserve(img);
            }
        });
    });
    
    // Setup lazy loading for related articles
    document.querySelectorAll('img[data-src]').forEach(img => {
        lazyImageObserver.observe(img);
    });
    
    // Add fade-in effect for elements as they scroll into view
    const fadeObserver = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                fadeObserver.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1 });
    
    document.querySelectorAll('.fade-in-section').forEach(el => {
        fadeObserver.observe(el);
    });
}

// Handle print requests with custom formatting
window.addEventListener('beforeprint', function() {
    document.body.classList.add('print-mode');
});

window.addEventListener('afterprint', function() {
    document.body.classList.remove('print-mode');
});

// Register service worker for offline reading if supported
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/static/sw.js').then(
            function(registration) {
                console.log('ServiceWorker registration successful');
            },
            function(err) {
                console.log('ServiceWorker registration failed: ', err);
            }
        );
    });
}
</script>
{% endblock %}