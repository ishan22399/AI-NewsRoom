{% extends "base.html" %}

{% block title %}{{ article.title }} - AI Newsroom{% endblock %}

{% block extra_css %}
<style>
    /* Modern Reading Experience */
    :root {
        --primary-color: #4f46e5;
        --primary-light: #a5b4fc;
        --primary-dark: #3730a3;
        --secondary-color: #10b981;
        --text-color: #1f2937;
        --text-light: #4b5563;
        --background: #ffffff;
        --background-alt: #f3f4f6;
        --accent: #f59e0b;
        --danger: #ef4444;
        --success: #10b981;
        --radius: 0.75rem;
        --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Reading progress bar with animated gradient */
    .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent));
        background-size: 200% 200%;
        animation: gradient-shift 3s ease infinite;
        z-index: 50;
        transition: width 0.1s ease;
    }

    @keyframes gradient-shift {
        0% {background-position: 0% 50%;}
        50% {background-position: 100% 50%;}
        100% {background-position: 0% 50%;}
    }
    
    /* Article content styling */
    .article-content {
        font-size: 1.125rem;
        line-height: 1.9;
        color: var(--text-color);
        max-width: 75ch;
        margin: 0 auto;
    }
    
    .article-content p {
        margin-bottom: 1.75rem;
    }
    
    .article-content h2 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-top: 2.5rem;
        margin-bottom: 1.25rem;
        color: var(--text-color);
        border-bottom: 2px solid var(--background-alt);
        padding-bottom: 0.5rem;
    }
    
    .article-content h3 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-top: 2rem;
        margin-bottom: 1rem;
        color: var(--text-color);
    }
    
    .article-content a {
        color: var(--primary-color);
        text-decoration: none;
        border-bottom: 1px solid var(--primary-light);
        transition: all 0.2s ease;
    }
    
    .article-content a:hover {
        color: var(--primary-dark);
        border-bottom-color: var(--primary-dark);
    }
    
    .article-content blockquote {
        border-left: 4px solid var(--primary-color);
        padding: 1rem 1.5rem;
        margin: 2rem 0;
        background-color: var(--background-alt);
        border-radius: 0 var(--radius) var(--radius) 0;
        font-style: italic;
        color: var(--text-light);
        position: relative;
    }
    
    .article-content blockquote::before {
        content: '"';
        position: absolute;
        top: -1.5rem;
        left: 0.5rem;
        font-size: 4rem;
        color: var(--primary-light);
        font-family: Georgia, serif;
        opacity: 0.3;
    }
    
    .article-content ul, .article-content ol {
        margin-bottom: 1.75rem;
        margin-left: 1.5rem;
        padding-left: 1rem;
    }
    
    .article-content li {
        margin-bottom: 0.75rem;
        position: relative;
    }
    
    .article-content ul li::before {
        content: '•';
        color: var(--primary-color);
        font-weight: bold;
        position: absolute;
        left: -1.25rem;
    }
    
    .article-content pre {
        background-color: #2d3748;
        color: #e5e7eb;
        padding: 1.25rem;
        border-radius: var(--radius);
        overflow-x: auto;
        margin-bottom: 1.75rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .article-content img {
        max-width: 100%;
        height: auto;
        border-radius: var(--radius);
        margin: 2rem auto;
        display: block;
        box-shadow: var(--shadow);
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .article-content img:hover {
        transform: scale(1.01);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* Hero image with overlay text */
    .article-hero-container {
        position: relative;
        border-radius: var(--radius);
        overflow: hidden;
        margin-bottom: 2rem;
        box-shadow: var(--shadow);
    }
    
    .article-hero-image {
        width: 100%;
        height: auto;
        object-fit: cover;
        max-height: 500px;
        min-height: 300px;
        transition: transform 0.5s ease;
    }
    
    .article-hero-container:hover .article-hero-image {
        transform: scale(1.025);
    }
    
    .article-hero-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        padding: 3rem 2rem 1.5rem;
        color: white;
    }
    
    /* Table of contents with active indicator */
    .toc {
        position: sticky;
        top: 5rem;
        max-height: calc(100vh - 8rem);
        overflow-y: auto;
        scrollbar-width: thin;
        padding-right: 1rem;
    }
    
    .toc::-webkit-scrollbar {
        width: 4px;
    }
    
    .toc::-webkit-scrollbar-track {
        background: var(--background-alt);
    }
    
    .toc::-webkit-scrollbar-thumb {
        background-color: var(--primary-light);
        border-radius: 4px;
    }
    
    .toc-link {
        position: relative;
        display: block;
        padding: 0.75rem 0;
        padding-left: 1.25rem;
        margin-bottom: 0.25rem;
        font-size: 0.925rem;
        color: var(--text-light);
        border-left: 2px solid #e5e7eb;
        transition: all 0.3s;
        text-decoration: none;
    }
    
    .toc-link:hover {
        color: var(--primary-color);
        border-left-color: var(--primary-light);
        background-color: rgba(79, 70, 229, 0.05);
        border-radius: 0 var(--radius) var(--radius) 0;
    }
    
    .toc-link.active {
        color: var(--primary-color);
        border-left-color: var(--primary-color);
        font-weight: 500;
        background-color: rgba(79, 70, 229, 0.1);
        border-radius: 0 var(--radius) var(--radius) 0;
    }
    
    /* Enhanced lightbox with zoom */
    .lightbox {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    
    .lightbox.active {
        opacity: 1;
        pointer-events: auto;
    }
    
    .lightbox-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
    }
    
    .lightbox-img {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
        border-radius: var(--radius);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    .lightbox-close {
        position: absolute;
        top: -3rem;
        right: 0;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.1);
        transition: background-color 0.2s;
    }
    
    .lightbox-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    /* Highlight text animation with better visual */
    .highlight {
        position: relative;
        display: inline;
        color: var(--primary-color);
        font-weight: 600;
        padding: 0 0.2em;
    }
    
    .highlight::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0.4em;
        background-color: rgba(79, 70, 229, 0.2);
        z-index: -1;
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        border-radius: 2px;
    }
    
    .highlight.animate::after {
        transform: scaleX(1);
    }
    
    /* Points notification */
    .points-notification {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background-color: var(--primary-color);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        z-index: 100;
        animation: point-notification 3s forwards;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    @keyframes point-notification {
        0% { opacity: 0; transform: translateY(20px); }
        10% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-20px); }
    }
    
    /* Enhanced responsive design for article */
    @media (max-width: 768px) {
        .article-content {
            font-size: 1rem;
            line-height: 1.8;
        }
        
        .article-content h2 {
            font-size: 1.5rem;
        }
        
        .article-hero-overlay {
            padding: 2rem 1rem 1rem;
        }
        
        .article-actions {
            flex-direction: column;
            gap: 1rem;
        }
        
        .article-actions-group {
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
    }
    
    /* Related articles with modern card design */
    .related-article-card {
        display: flex;
        flex-direction: column;
        height: 100%;
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background-color: var(--background);
    }
    
    .related-article-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .related-article-image {
        width: 100%;
        aspect-ratio: 16/9;
        object-fit: cover;
    }
    
    .related-article-content {
        padding: 1rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    
    .related-article-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        color: var(--text-color);
    }
    
    .related-article-card:hover .related-article-title {
        color: var(--primary-color);
    }
    
    .related-article-summary {
        color: var(--text-light);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .related-article-meta {
        margin-top: auto;
        font-size: 0.75rem;
        color: var(--text-light);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* AI components */
    .ai-component {
        border-radius: var(--radius);
        overflow: hidden;
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .ai-component:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
    }
    
    .ai-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
    }
    
    .ai-icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    
    .ai-content {
        padding: 1.25rem;
        background-color: white;
        border: 1px solid #e5e7eb;
        border-top: none;
    }
    
    /* Article actions bar */
    .article-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 0;
        margin: 2rem 0;
        border-top: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .article-actions-group {
        display: flex;
        gap: 0.75rem;
    }
    
    .action-button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: var(--radius);
        font-weight: 500;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
    }
    
    .action-button-primary {
        background-color: var(--primary-color);
        color: white;
    }
    
    .action-button-primary:hover {
        background-color: var(--primary-dark);
    }
    
    .action-button-secondary {
        background-color: var(--background-alt);
        color: var(--text-color);
    }
    
    .action-button-secondary:hover {
        background-color: #e5e7eb;
    }
    
    /* Toast notification */
    .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background-color: var(--text-color);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        z-index: 50;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
    }
    
    .toast.show {
        transform: translateY(0);
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<!-- Reading progress bar -->
<div class="reading-progress" id="readingProgress"></div>

<!-- Article container -->
<div class="max-w-6xl mx-auto px-4 py-6 md:py-10">
    <!-- Breadcrumbs -->
    <nav class="mb-6 text-sm text-gray-500">
        <ol class="flex items-center flex-wrap gap-2">
            <li><a href="{{ url_for('dashboard') }}" class="hover:text-indigo-600 flex items-center gap-1"><i class="fas fa-home"></i> Home</a></li>
            <li class="flex items-center gap-2">
                <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <a href="#" class="hover:text-indigo-600">{{ article.category|default('News') }}</a>
            </li>
            <li class="flex items-center gap-2">
                <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <span class="text-gray-700 font-medium">Article</span>
            </li>
        </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Main article content -->
        <div class="lg:col-span-8">
            <!-- Article header -->
            <header class="mb-8">
                <!-- Title & Metadata -->
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 leading-tight">{{ article.title }}</h1>
                
                <!-- Source and author info -->
                <div class="flex flex-wrap items-center text-sm text-gray-500 mb-6 gap-4">
                    <div class="flex items-center bg-indigo-50 px-3 py-1 rounded-full">
                        <span class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center mr-2">
                            <i class="fas fa-newspaper text-indigo-600 text-xs"></i>
                        </span>
                        <span class="font-medium">{{ article.source.name|default('Unknown Source') }}</span>
                    </div>
                    
                    {% if article.author %}
                    <div class="flex items-center">
                        <span class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center mr-2">
                            <i class="fas fa-user text-indigo-600 text-xs"></i>
                        </span>
                        <span>{{ article.author }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="flex items-center">
                        <i class="far fa-calendar-alt mr-2 text-gray-400"></i>
                        <span>{{ article.published_at }}</span>
                    </div>
                    
                    <div class="flex items-center read-time-tooltip">
                        <i class="far fa-clock mr-2 text-gray-400"></i>
                        <span data-reading-time>{{ article.read_time }} min read</span>
                        <span class="tooltip-text">Estimated reading time</span>
                    </div>
                </div>
                
                <!-- Tags with improved styling -->
                <div class="flex flex-wrap gap-2 mb-6">
                    {% for tag in article.tags %}
                    <a href="#" class="px-3 py-1.5 bg-gray-100 text-gray-800 rounded-full text-sm hover:bg-indigo-100 hover:text-indigo-700 transition-colors">
                        #{{ tag }}
                    </a>
                    {% endfor %}
                </div>
            </header>
            
            <!-- Featured image with overlay -->
            <div class="article-hero-container mb-8">
                <img src="{{ article.image_url }}" 
                     alt="{{ article.title }}" 
                     class="article-hero-image"
                     onerror="this.src='https://via.placeholder.com/1200x630/4f46e5/ffffff?text=Article+Image'">
                <div class="article-hero-overlay opacity-0 md:opacity-100">
                    <div class="flex justify-end">
                        <button class="bg-white bg-opacity-20 hover:bg-opacity-100 rounded-full p-2 text-white hover:text-indigo-600 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" onclick="window.open('{{ article.image_url }}', '_blank')">
                            <i class="fas fa-expand-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Article content with data-article-id for tracking -->
            <article class="article-content mb-12" data-article-id="{{ article.id }}">
                {% if article.content|length > 100 %}
                    {{ article.content|safe }}
                {% else %}
                <div class="bg-gradient-to-r from-gray-50 to-indigo-50 p-6 rounded-xl border border-gray-200 mb-6">
                    <div class="flex items-start gap-4">
                        <div class="bg-indigo-100 p-3 rounded-full">
                            <i class="fas fa-info-circle text-indigo-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-3 text-gray-900">Article Preview</h3>
                            <p class="text-gray-700 mb-4">The full article content is available at the original source. Below is a summary of the article.</p>
                            
                            {% if article.description %}
                            <div class="mb-5 p-4 bg-white rounded-lg border border-gray-100">
                                <h4 class="text-lg font-semibold mb-2 text-gray-800">Summary</h4>
                                <p class="text-gray-700">{{ article.description }}</p>
                            </div>
                            {% endif %}
                            
                            <a href="{{ article.url }}" target="_blank" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                                <i class="fas fa-external-link-alt mr-2"></i> Continue reading at original source
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <p class="text-sm text-gray-500">
                            Source: <a href="{{ article.url|default('#') }}" target="_blank" class="text-indigo-600 hover:text-indigo-800">{{ article.source.name|default('Unknown Source') }}</a>
                        </p>
                        
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-500">Was this article helpful?</span>
                            <button class="p-1.5 bg-green-100 hover:bg-green-200 text-green-600 rounded-full transition-colors">
                                <i class="fas fa-thumbs-up"></i>
                            </button>
                            <button class="p-1.5 bg-red-100 hover:bg-red-200 text-red-600 rounded-full transition-colors">
                                <i class="fas fa-thumbs-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </article>
            
            <!-- Enhanced article actions bar -->
            <div class="article-actions">
                <!-- Left side: Save & Share -->
                <div class="article-actions-group">
                    <button class="action-button action-button-primary">
                        <i class="fas fa-bookmark"></i> Save
                    </button>
                    <button class="action-button action-button-secondary" id="shareButton">
                        <i class="fas fa-share-alt"></i> Share
                    </button>
                    <button class="action-button action-button-secondary" onclick="window.print()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
                
                <!-- Right side: Reactions -->
                <div class="article-actions-group">
                    <button class="action-button action-button-secondary">
                        <i class="far fa-comment"></i> Comment
                    </button>
                    <button class="action-button action-button-secondary">
                        <i class="fas fa-microphone"></i> Listen
                    </button>
                </div>
            </div>
            
            <!-- Related articles with enhanced design -->
            <div class="mb-12">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <i class="fas fa-newspaper text-indigo-600"></i> Related Articles
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% for related in related_articles|default([]) %}
                    <a href="{{ related.url|default('#') }}" class="related-article-card">
                        <img src="{{ related.image_url|default('https://via.placeholder.com/400x300/4f46e5/ffffff?text=Related') }}" 
                             alt="{{ related.title }}" 
                             class="related-article-image">
                        <div class="related-article-content">
                            <h3 class="related-article-title">{{ related.title }}</h3>
                            <p class="related-article-summary">{{ related.summary }}</p>
                            <div class="related-article-meta">
                                <i class="far fa-newspaper text-indigo-400"></i>
                                <span>{{ related.source }} · {{ related.published_at }}</span>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                    
                    {% if not related_articles or related_articles|length == 0 %}
                    <div class="col-span-3 text-center p-8 bg-gray-50 rounded-xl">
                        <p class="text-gray-500">No related articles available at this time.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Enhanced sidebar -->
        <aside class="lg:col-span-4 order-first lg:order-last">
            <!-- Table of contents with visual improvements -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6 sticky top-24">
                <div class="flex items-center gap-2 mb-4">
                    <div class="bg-indigo-100 p-1.5 rounded-full">
                        <i class="fas fa-list text-indigo-600"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Table of Contents</h3>
                </div>
                <div class="toc" id="tableOfContents">
                    <!-- Dynamically generated -->
                    <div class="text-sm text-gray-500 py-2 px-4 bg-gray-50 rounded-lg">
                        Content sections will appear here as you scroll.
                    </div>
                </div>
            </div>
            
            <!-- AI Summary with enhanced design -->
            <div class="ai-component">
                <div class="ai-header">
                    <div class="ai-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h3 class="text-lg font-bold">AI Summary</h3>
                </div>
                <div class="ai-content">
                    <p class="text-gray-700 mb-4">
                        {{ article.description|default('No summary available for this article. I can generate one for you to help understand the key points.') }}
                    </p>
                    <button class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
                        <i class="fas fa-magic mr-1"></i> Generate deeper analysis
                    </button>
                </div>
            </div>
            
            <!-- Ask AI about this article with enhanced design -->
            <div class="ai-component">
                <div class="ai-header">
                    <div class="ai-icon">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <h3 class="text-lg font-bold">Ask AI Assistant</h3>
                </div>
                <div class="ai-content">
                    <div class="mb-4">
                        <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ask a question about this article...">
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm transition-colors">What are the key points?</button>
                        <button class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm transition-colors">Explain further</button>
                        <button class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm transition-colors">Generate insights</button>
                    </div>
                </div>
            </div>
            
            <!-- Reading statistics -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6">
                <div class="flex items-center gap-2 mb-4">
                    <div class="bg-indigo-100 p-1.5 rounded-full">
                        <i class="fas fa-chart-line text-indigo-600"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Reading Stats</h3>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Word Count</span>
                        <span class="font-medium" id="wordCount">Calculating...</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Read Time</span>
                        <span class="font-medium">{{ article.read_time }} minutes</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">Last Updated</span>
                        <span class="font-medium">{{ article.published_at }}</span>
                    </div>
                    <div class="pt-3 mt-3 border-t border-gray-100">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm text-gray-600">Reading Progress</span>
                            <span class="text-sm font-medium text-indigo-600" id="readingPercentage">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-600 h-2 rounded-full" id="readingProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Enhanced lightbox -->
<div class="lightbox" id="imageLightbox">
    <div class="lightbox-content">
        <span class="lightbox-close" onclick="window.closeLightbox()">
            <i class="fas fa-times"></i>
        </span>
        <img class="lightbox-img" id="lightboxImage" src="" alt="Enlarged Image">
    </div>
</div>

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<!-- JavaScript with improved functionality -->
<script>
// Initialize variables
window.startTime = new Date();
window.readingCompleted = false;
const article = document.querySelector('.article-content');

// Update reading progress bar and percentage
function updateReadingProgress() {
    if (!article) return;
    
    const scrollTop = window.scrollY;
    const scrollHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const progressBar = document.getElementById('readingProgress');
    const readingProgressBar = document.getElementById('readingProgressBar');
    const readingPercentage = document.getElementById('readingPercentage');
    
    if (scrollTop === 0) {
        progressBar.style.width = '0%';
        if (readingProgressBar) readingProgressBar.style.width = '0%';
        if (readingPercentage) readingPercentage.textContent = '0%';
        return;
    }
    
    const scrolled = (scrollTop / (scrollHeight - windowHeight)) * 100;
    const percentage = Math.min(Math.round(scrolled), 100);
    
    progressBar.style.width = percentage + '%';
    if (readingProgressBar) readingProgressBar.style.width = percentage + '%';
    if (readingPercentage) readingPercentage.textContent = percentage + '%';
    
    // Only track complete reads if we're near the end
    if (scrolled > 85 && !window.readingCompleted) {
        window.readingCompleted = true;
        
        // Record complete read event
        fetch('/api/articles/read-complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                article_id: '{{ article.id }}',
                read_time: Math.round((new Date() - window.startTime) / 1000 / 60) // time in minutes
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.points_awarded > 0) {
                // Show points notification
                const notification = document.createElement('div');
                notification.className = 'points-notification';
                notification.innerHTML = `
                    <i class="fas fa-award"></i>
                    <span>+${data.points_awarded} points for reading!</span>
                `;
                document.body.appendChild(notification);
                
                // Remove after animation completes
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error tracking reading completion:', error);
        });
    }
}

// Enhanced lightbox functionality
window.openLightbox = function(imgSrc) {
    document.getElementById('lightboxImage').src = imgSrc;
    document.getElementById('imageLightbox').classList.add('active');
    document.body.style.overflow = 'hidden';
    document.addEventListener('keydown', handleLightboxKeyDown);
};

window.closeLightbox = function() {
    document.getElementById('imageLightbox').classList.remove('active');
    document.body.style.overflow = '';
    document.removeEventListener('keydown', handleLightboxKeyDown);
};

function handleLightboxKeyDown(e) {
    if (e.key === 'Escape') {
        window.closeLightbox();
    }
}

// Better Table of Contents implementation
function buildTableOfContents() {
    if (!article) return;
    
    const toc = document.getElementById('tableOfContents');
    const headings = article.querySelectorAll('h2, h3');
    
    if (headings.length === 0) {
        toc.innerHTML = '<p class="text-sm text-gray-500 py-3">No sections available for this article.</p>';
        return;
    }
    
    let tocHTML = '';
    
    headings.forEach((heading, index) => {
        const id = `section-${index}`;
        heading.id = id;
        
        const indent = heading.tagName === 'H3' ? 'ml-4' : '';
        const icon = heading.tagName === 'H2' 
            ? '<i class="fas fa-bookmark text-indigo-400 mr-2"></i>' 
            : '<i class="fas fa-angle-right text-indigo-300 mr-2"></i>';
            
        tocHTML += `<a href="#${id}" class="toc-link ${indent}" data-section="${id}">${icon}${heading.textContent}</a>`;
    });
    
    toc.innerHTML = tocHTML || '<p class="text-sm text-gray-500 py-3">No sections available for this article.</p>';
    
    // Add smooth scrolling for TOC links
    document.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            
            if (targetElement) {
                window.scrollTo({
                    top: targetElement.offsetTop - 100,
                    behavior: 'smooth'
                });
                
                // Update URL without page reload
                history.pushState(null, null, targetId);
            }
        });
    });
}

function updateTOC() {
    if (!article) return;
    
    const headings = article.querySelectorAll('h2, h3');
    if (headings.length === 0) return;
    
    const tocLinks = document.querySelectorAll('.toc-link');
    if (tocLinks.length === 0) return;
    
    let activeSection = null;
    
    headings.forEach((heading) => {
        const rect = heading.getBoundingClientRect();
        if (rect.top <= 150) { // Adjust based on your layout
            activeSection = heading.id;
        }
    });
    
    tocLinks.forEach(link => {
        link.classList.remove('active');
        if (link.dataset.section === activeSection) {
            link.classList.add('active');
        }
    });
}

// Calculate and display word count
function calculateWordCount() {
    if (!article) return;
    
    const text = article.textContent || '';
    const wordCount = text.split(/\s+/).filter(Boolean).length;
    
    const wordCountElement = document.getElementById('wordCount');
    if (wordCountElement) {
        wordCountElement.textContent = wordCount.toLocaleString();
    }
    
    // Update reading time based on word count
    const readingTime = Math.ceil(wordCount / 225); // 225 words per minute is average reading speed
    const readingTimeElement = document.querySelector('[data-reading-time]');
    if (readingTimeElement) {
        readingTimeElement.textContent = `${readingTime} min read`;
    }
}

// Toast notification function
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Initialize everything when DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Build table of contents
    buildTableOfContents();
    
    // Initialize reading progress
    updateReadingProgress();
    window.addEventListener('scroll', function() {
        updateReadingProgress();
        updateTOC();
    });
    
    // Calculate word count
    calculateWordCount();
    
    // Make article images open in lightbox
    const articleImages = document.querySelectorAll('.article-content img, .article-hero-image img');
    articleImages.forEach(img => {
        // Preload for smoother lightbox experience
        const tempImage = new Image();
        tempImage.src = img.src;
        
        // Add click handler
        img.addEventListener('click', function() {
            window.openLightbox(img.src);
        });
    });
    
    // Check for URL hash on page load and scroll to that section
    if (window.location.hash) {
        const targetElement = document.querySelector(window.location.hash);
        if (targetElement) {
            setTimeout(() => {
                window.scrollTo({
                    top: targetElement.offsetTop - 100,
                    behavior: 'smooth'
                });
            }, 300);
        }
    }
    
    // Highlight text animation on scroll
    const highlights = document.querySelectorAll('.highlight');
    const animateHighlights = function() {
        highlights.forEach(highlight => {
            const rect = highlight.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            
            if (rect.top < viewportHeight * 0.85 && rect.bottom > 0) {
                highlight.classList.add('animate');
            } else {
                highlight.classList.remove('animate');
            }
        });
    };
    
    // Run highlight animation on scroll and once on load
    window.addEventListener('scroll', animateHighlights);
    animateHighlights();
    
    // Make tables responsive
    const tables = document.querySelectorAll('.article-content table');
    tables.forEach(table => {
        // Wrap table in a responsive container if not already
        if (!table.parentNode.classList.contains('table-responsive')) {
            const wrapper = document.createElement('div');
            wrapper.className = 'table-responsive overflow-x-auto mb-6';
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
        }
    });
    
    // Handle image loading errors
    document.querySelectorAll('img').forEach(img => {
        img.addEventListener('error', function() {
            this.src = 'https://via.placeholder.com/800x450/4f46e5/ffffff?text=Image+Not+Available';
        });
    });
    
    // Share button functionality
    document.getElementById('shareButton')?.addEventListener('click', function() {
        if (navigator.share) {
            navigator.share({
                title: '{{ article.title }}',
                text: '{{ article.description }}',
                url: window.location.href
            })
            .then(() => showToast('Article shared successfully!'))
            .catch((error) => console.log('Error sharing:', error));
        } else {
            // Fallback for browsers that don't support Web Share API
            showToast('Copy this page URL to share the article');
            
            // Create and select temporary input
            const input = document.createElement('input');
            input.value = window.location.href;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            
            showToast('Link copied to clipboard!');
        }
    });
});

// Run highlight animation on scroll and once on load
window.addEventListener('scroll', function() {
    const highlights = document.querySelectorAll('.highlight');
    highlights.forEach(highlight => {
        const rect = highlight.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        
        if (rect.top < viewportHeight * 0.85 && rect.bottom > 0) {
            highlight.classList.add('animate');
        } else {
            highlight.classList.remove('animate');
        }
    });
});

// Handle print requests with custom formatting
window.addEventListener('beforeprint', function() {
    document.body.classList.add('print-mode');
});

window.addEventListener('afterprint', function() {
    document.body.classList.remove('print-mode');
});
</script>
{% endblock %}
